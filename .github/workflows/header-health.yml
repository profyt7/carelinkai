name: Header Health Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  check-headers:
    name: Validate Set-Cookie headers on production
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        endpoint: ["/", "/api/auth/session"]
    steps:
      - name: Fetch response headers
        id: fetch
        run: |
          URL="https://carelinkai.onrender.com${{ matrix.endpoint }}"
          echo "Requesting: $URL"
          curl -s -D headers.txt -o /dev/null "$URL"
          echo "--- Response headers ---"
          cat headers.txt
      - name: Ensure no invalid Set-Cookie headers are present
        run: |
          echo "Validating Set-Cookie hygiene..."
          # Fail if any Set-Cookie header starts with attributes instead of a cookie name
          if grep -iE '^Set-Cookie:\s*(Path=|HttpOnly|Secure|SameSite)' headers.txt; then
            echo "Found an invalid Set-Cookie header that starts with attributes (no cookie name)." >&2
            exit 1
          fi

          # Fail if any Set-Cookie lacks an '=' before the first ';'
          # Extract Set-Cookie lines, strip prefix, then check the first token before ';'
          BAD=0
          while IFS= read -r line; do
            cookie_part=$(echo "$line" | sed -E 's/^Set-Cookie:\s*//I' | cut -d';' -f1)
            if ! echo "$cookie_part" | grep -q '='; then
              echo "Malformed Set-Cookie (no name=value): $line" >&2
              BAD=1
            fi
          done < <(grep -i '^Set-Cookie:' headers.txt || true)

          if [ "$BAD" -ne 0 ]; then
            exit 1
          fi

          echo "Set-Cookie headers look sane."
      - name: Upload headers artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          # Use expression functions; remove slashes from endpoint for a valid artifact name
          name: ${{ format('headers-{0}', replace(matrix.endpoint, '/', '')) }}
          path: headers.txt
