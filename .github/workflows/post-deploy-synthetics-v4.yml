name: Post Deploy Synthetics (v4 minimal)

on:
  push:
    branches: [ main ]

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Say hello
        run: echo "v4 minimal job started"
      - name: Health check
        shell: bash
        env:
          HEALTH_URL: https://carelinkai.onrender.com/api/health
        run: |
          set -euo pipefail
          code=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)
          echo "health -> $code"
          if [ "$code" != "200" ]; then
            echo "Health endpoint returned $code" >&2
            exit 1
          fi
      - name: SSE ready check
        shell: bash
        env:
          SSE_URL: https://carelinkai.onrender.com/api/sse?topics=system
        run: |
          set -euo pipefail
          echo "connecting to $SSE_URL"
          if curl -sS -N --max-time 10 -H "Accept: text/event-stream" "$SSE_URL" | grep -m1 -E "^event: ready"; then
            echo "SSE ready event observed"
          else
            echo "SSE ready event NOT observed" >&2
            exit 1
          fi
