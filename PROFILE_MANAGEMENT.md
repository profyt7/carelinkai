# CareLinkAI – User Profile Management Guide

This document explains the profile management capabilities that were added to CareLinkAI, including API reference, features, security considerations, and how to test and use each endpoint.

---

## 1. Overview

The profile management subsystem lets authenticated users:

* View and edit their personal data (name, phone, addresses, etc.)
* Maintain role-specific information (Family, Operator, Caregiver, Affiliate, Admin)
* Upload, replace, or delete a profile photo
* Manage granular preferences (notifications, privacy, accessibility, display, role-specific)
* Change their password securely

All endpoints are **authenticated** with a valid session/JWT generated by NextAuth.

---

## 2. API Endpoints

| Action | Method & Path | Description |
|--------|---------------|-------------|
| Get profile | **GET** `/api/profile` | Returns base user fields, role-specific section, and addresses |
| Update profile | **PATCH** `/api/profile` | Partial update of base or role-specific fields and address |
| Upload photo | **POST** `/api/profile/photo` | Uploads a new profile image (PNG/JPEG/WebP ≤ 5 MB) |
| Delete photo | **DELETE** `/api/profile/photo` | Deletes all stored profile images for the user |
| Get preferences | **GET** `/api/profile/preferences` | Returns combined preference object |
| Update preferences | **PUT** `/api/profile/preferences` | Full update (replace) of preferences |
| Partial update preferences | **PATCH** `/api/profile/preferences` | Patch selected preference sections |
| Change password | **POST** `/api/profile/change-password` | Verify current password & set a new one |

---

## 3. Feature Matrix

### 3.1 Base Profile Fields
* `firstName`, `lastName`
* `phone`
* `timezone`
* `notificationPrefs` (quick-access e-mail/SMS/in-app toggles)
* **Address** (street, city, state, zip, country, lat/long)

### 3.2 Role-Specific Fields

| Role | Extra Fields |
|------|--------------|
| Family | `emergencyContact`, `emergencyPhone` |
| Operator | `companyName`, `taxId`, `businessLicense` |
| Caregiver | `bio`, `yearsExperience`, `hourlyRate`, `availability` |
| Affiliate | `organization`, `commissionRate`, `paymentDetails` |
| Admin | No additional fields (system level) |

### 3.3 Preferences
* **Notifications** – fine-grained toggles for e-mail/SMS/in-app per category
* **Privacy** – profile visibility, data-sharing consents
* **Accessibility** – high contrast, large text, reduced motion, color-blind modes
* **Display** – theme, language, date/time formatting
* **Role-Specific** – e.g. care update frequency, occupancy alerts, referral updates

### 3.4 Profile Photo Handling
* Accepts `image/jpeg`, `image/png`, `image/webp`
* Generates three sizes: `thumbnail` (150 × 150), `medium` (300 × 300), `large` (600 × 600)
* Stored under `public/uploads/profiles/<userId>/`
* Old photos automatically cleaned up
* Public URL returned in response (e.g. `/uploads/profiles/<id>/<file>`)  

---

## 4. Security Measures

1. **Authentication** – Every route uses `getServerSession(authOptions)` to ensure a valid JWT/session.
2. **Role-Aware Validation** – Zod schemas tailored per role prevent over-posting.
3. **Rate Limiting** – Password change endpoint limited to 5 attempts / 15 min per IP.
4. **File Validation**  
   • MIME & size check (≤ 5 MB)  
   • Processed with `sharp` to strip metadata & enforce size
5. **Audit Logging** – Every read/update/delete creates a record in `AuditLog` with IP, action, and metadata.
6. **Token Security** – JWT contains only non-sensitive data; no password hashes ever leave server.
7. **Input Sanitisation** – All body payloads pass Zod parsing; invalid fields rejected with `400`.

---

## 5. Usage Examples

Replace `${TOKEN}` with the bearer token returned from `/api/auth/login`.

### 5.1 Get My Profile
```
curl -H "Authorization: Bearer ${TOKEN}" \
     https://localhost:5002/api/profile
```

### 5.2 Update Phone Number
```
curl -X PATCH -H "Content-Type: application/json" \
     -H "Authorization: Bearer ${TOKEN}" \
     -d '{"phone":"555-123-0000"}' \
     https://localhost:5002/api/profile
```

### 5.3 Upload Profile Photo
```
curl -X POST -H "Authorization: Bearer ${TOKEN}" \
     -F "photo=@/path/to/me.png" \
     https://localhost:5002/api/profile/photo
```

### 5.4 Change Password
```
curl -X POST -H "Content-Type: application/json" \
     -H "Authorization: Bearer ${TOKEN}" \
     -d '{
           "currentPassword":"OldPass123!",
           "newPassword":"NewPass456!",
           "confirmPassword":"NewPass456!"
         }' \
     https://localhost:5002/api/profile/change-password
```

### 5.5 Update Preferences (partial)
```
curl -X PATCH -H "Content-Type: application/json" \
     -H "Authorization: Bearer ${TOKEN}" \
     -d '{ "display": { "theme":"DARK" } }' \
     https://localhost:5002/api/profile/preferences
```

---

## 6. Testing Instructions

Automated test scripts live in the repo root:

| Script | What it does |
|--------|--------------|
| `test-profile-management.js` | End-to-end tests covering every endpoint above for all roles |
| `test-complete-auth-flow.js` | Full registration → verification → 2FA → profile flow |

Run:

```bash
# Make sure dev server & DB are running
npm run dev   # in one terminal

# In another terminal
node test-profile-management.js
```

Expect all ✅ passes. Failures will print detailed diff and last HTTP response.

---

## 7. Extensibility Roadmap

* S3 / Cloud storage adapter for photos
* Admin-side impersonation & profile moderation
* Versioned preference schema migrations
* Custom webhook events on profile updates for downstream services

---

© 2025 CareLinkAI. All rights reserved.
